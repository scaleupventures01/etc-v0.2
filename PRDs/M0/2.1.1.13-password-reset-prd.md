---
name: password-reset-prd
version: 1.0
date: 2025-08-12
status: Draft
owner: Implementation Owner
source: Plans/product-roadmap.md (M0 Founder Instance)
milestone: M0 (2.1.1.13)
---

<a id="sec-1"></a>
## 1. Executive Summary

Provide a secure "Forgot password" and "Reset password" flow using time‑bound, single‑use tokens sent via email. On successful reset, update the user's password hash, invalidate prior tokens and active sessions, and rotate the session. Mitigate account enumeration and abuse via uniform responses and rate limits.

<a id="sec-2"></a>
## 2. Scope
- In scope:
  - `POST /api/auth/forgot-password` → issue time‑bound, single‑use token; send email with reset link
  - `POST /api/auth/reset-password` → verify token; set new password; invalidate prior sessions/tokens
  - Data model/table for reset tokens; token hashing and TTL enforcement (15–30 min)
  - Rate limiting (per IP + email) and attempt counters; one active token per user
  - UX: add "Forgot password?" link on `login`; `forgot-password` and `reset-password` pages/forms
  - QA scenarios: request, valid/invalid/expired/used token, replay attempt, session rotation
- Out of scope:
  - MFA setup/recovery; social SSO recovery; passwordless login; email deliverability SLOs beyond baseline

<a id="sec-3"></a>
## 3. Success Criteria
- ≥95% successful reset completion when user follows a valid link within TTL
- Uniform API responses to mitigate enumeration; errors are generic in UI
- Security scans: no High/Critical (deps/SAST/secrets/SBOM)
- QA results Overall Status: Pass with evidence; routes wired and accessible

<a id="sec-4"></a>
## 4. User Stories
- As a user, I can request a password reset link via email and receive a confirmation message.
- As a user, I can set a new password using a valid, unexpired link.
- As a user, my prior sessions are invalidated after reset, and I am logged in with a fresh session.

<a id="sec-5"></a>
## 5. Functional Requirements
1. Forgot endpoint always returns 200 `{ ok: true }` regardless of account existence; rate‑limited.
2. If account exists: create single‑use token with TTL; store only the token hash; send email link.
3. Reset endpoint verifies token; on success updates `passwordHash` (argon2/bcrypt); marks token used; invalidates other tokens and active sessions; rotates session.
4. Token replay attempts must fail; expired/used tokens return 410/400 with generic UI message.
5. Audit basic events (request, issued, used, invalid/expired) with IP/UA.

<a id="sec-6"></a>
## 6. Technical Requirements

<a id="sec-6-1"></a>
### 6.1 Architecture
- Next.js App Router API routes under `infra/next-app/app/api/auth/` for `forgot-password` and `reset-password`.
- CSPRNG token generation; store only hash in DB; constant‑time compare; single‑use.
- Session management aligned with 2.1.1.4; rotate session post‑reset.

<a id="sec-6-2"></a>
### 6.2 Data Model
- `PasswordResetToken { id, userId, tokenHash, expiresAt, usedAt, createdAt, createdIp, createdUa }`
- Indices: `tokenHash` unique; composite `userId+expiresAt`; enforce one active token per user.

<a id="sec-6-3"></a>
### 6.3 Storage/Schema
- Prisma model for `PasswordResetToken`; migrations in `infra/next-app/prisma/`.
- Email adapter abstraction: dev sink (logs/file) and prod provider (e.g., SMTP/Resend).

<a id="sec-6-4"></a>
### 6.4 Validation
- Email format; password strength (min length, complexity per policy); token length and format.
- Rate limits: forgot endpoint per IP+email; reset endpoint per token/IP.

<a id="sec-6-5"></a>
### 6.5 UI/UX
- `login` page adds a "Forgot password?" link.
- `forgot-password` page with email field; neutral success copy regardless of existence.
- `reset-password` page: new password + confirm; success page; generic error on invalid token.

<a id="sec-6-6"></a>
### 6.6 Legal/Privacy
- No credential logging; cookie/session policy reused; privacy copy for email usage; secure flags on cookies.

<a id="sec-7"></a>
## 7. Testing & Acceptance

<a id="sec-7-1"></a>
### 7.1 Test Scenarios
1. Forgot: existing email → token issued; email sink contains link; API 200.
2. Forgot: non‑existing email → API 200; no token created.
3. Rate limit: multiple requests per IP/email → limited with 429 after threshold.
4. Reset: valid token → password updated; prior sessions invalid; new session active.
5. Reset: invalid/expired/used token → denied; generic UI message; API 400/410.
6. Replay attempt: previously used token → denied.
7. Security scans: deps/SAST/secrets/SBOM → no High/Critical.

<a id="sec-7-2"></a>
### 7.2 Acceptance Criteria
- All scenarios pass; Overall Status: Pass recorded in QA results.

<a id="sec-7-3"></a>
### 7.3 QA Artifacts
- Test cases file: `QA/2.1.1.13-password-reset/test-cases.md`
- Latest results: `QA/2.1.1.13-password-reset/test-results-<yyyy-mm-dd>.md` (Overall Status: Pass required)

<a id="sec-8"></a>
## 8. Changelog
- v1.0: Initial draft and QA scaffold created.

<a id="sec-9"></a>
## 9. Collaboration & Review Workflow

<a id="sec-9-1"></a>
### 9.1 Roles and Order
- PM → VP-Product → Technical Product Manager → CTO → Security → UX/UI → Legal → QA → VP‑Eng → Implementation Owner

<a id="sec-9-2"></a>
### 9.2 Where Communication Happens
- Primary: this PRD (`PRDs/M0/2.1.1.13-password-reset-prd.md`)
- Status: `Plans/product-roadmap.md` (2.1.1.13)

<a id="sec-9-3"></a>
### 9.3 Handoff Contracts (Inputs → Outputs)
- PM: scope/user stories/acceptance
- VP-Product: KPIs/gates (reset success rate, error rates)
- Technical Product Manager: endpoint/data model specs; §10 links
- CTO: hashing algorithm, token/session policy, rate limiting
- Security: scans plan; threat model; no High/Critical gate
- UX: form labels/copy; error/neutral messaging
- Legal: privacy copy
- QA: test scenarios/results
- VP‑Eng: feasibility/sequencing
- Implementation Owner: implementation + rollback

<a id="sec-9-4"></a>
### 9.4 Review Log & Sign‑offs
- [ ] PM — Confirmed
- [ ] VP-Product — Confirmed
- [ ] Technical Product Manager — Confirmed; §10 links
- [ ] CTO — Confirmed
- [ ] Security — Scans attached; no High/Critical
- [ ] UX — Confirmed
- [ ] Legal — Confirmed (or N/A)
- [ ] QA — Results published at: `QA/2.1.1.13-password-reset/test-results-<yyyy-mm-dd>.md`
- [ ] VP‑Eng — Ready
- [ ] Implementation Owner — Risks/rollback

<a id="sec-9-5"></a>
### 9.5 Reviewer Notes

<a id="sec-9-6"></a>
### 9.6 Decision Log

<a id="sec-9-7"></a>
### 9.7 Open Questions
- TTL default: 15 vs 30 minutes?
- Argon2 vs bcrypt default per infra baseline?
- Password complexity requirements and copy.

<a id="sec-9-8"></a>
### 9.8 Ready‑to‑Implement Gate
- Condition: 9.4 all checked + QA Results Pass.
- Action: Flip roadmap; mirror HTML.

<a id="sec-10"></a>
## 10. Excellence Checklist (link evidence per `docs/Excellence-Standard.md`)
- [ ] Scope/intent clear; dependencies and order documented
- [ ] Minimal, reversible edits; rollback steps noted in 9.6 (if risk > low)
- [ ] Lints/build/unit/integration/E2E green (as applicable)
- [ ] QA results published and linked: `QA/2.1.1.13-password-reset/test-results-<yyyy-mm-dd>.md` (Overall Status: Pass)
- [ ] Security evidence linked — no High/Critical outstanding
- [ ] Roadmap + `docs/product-roadmap.html` updated; links verified


