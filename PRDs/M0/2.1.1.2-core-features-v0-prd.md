---
name: core-features-v0-prd
version: 1.0
date: 2025-08-12
status: Draft
owner: Implementation Owner
source: Plans/product-roadmap.md (M0 Founder Instance); Input/business-plan-v2.md
milestone: M0 (2.1.1.2)
---

<a id="sec-1"></a>
## 1. Executive Summary

Deliver a functional v0 of core features: Rules CRUD, a deterministic Verdict engine, Journal entries with optional verdict snapshots, and minimal Analytics. Operate local-first using existing storage utilities; gate subfeatures behind flags; keep evaluation deterministic with p95 ≤ 3s.

<a id="sec-2"></a>
## 2. Scope
- In scope:
  - Rules CRUD with enable/disable and ordering/priority semantics.
  - Verdict v0: evaluate active rules against a trade input; return verdict + rule hits.
  - Journal v0: create/edit entries (datetime, symbol, side, size, entry/exit, P&L, notes/tags); optional verdict snapshot.
  - Analytics v0: counts, win rate, average R:R computed from journal.
  - Local-first persistence via `js/core/storage.js`; document keys/schema.
- Out of scope:
  - Advanced analytics (MFE/ATR handled in 2.1.1.10 / 2.1.1.11).
  - AuthN flows (2.1.1.4) and external DB (2.1.1.3) until available.
  - Multi-tenant UI and role-based controls (later milestones).

<a id="sec-3"></a>
## 3. Success Criteria
- Happy path: Create rule → Evaluate verdict for a trade → Save journal entry with snapshot → View analytics, with zero console errors.
- Verdict p95 ≤ 3s; evaluation deterministic (same inputs → same outputs).
- QA results Overall Status: Pass; security scans report no High/Critical.

<a id="sec-4"></a>
## 4. User Stories
- As a user, I can define and toggle rules that shape my trading discipline.
- As a user, I can run a verdict and see which rules triggered and why.
- As a user, I can journal trades with key fields and optional verdict context.
- As a user, I can view basic analytics (counts, win rate, average R:R) from my journal.

<a id="sec-5"></a>
## 5. Functional Requirements
1. Rules CRUD (create, read, update, delete) with `active` and `priority` fields; stable evaluation order.
2. Verdict API: `evaluate(tradeInput, activeRules) → { verdict, reasons, hits }`.
3. Journal entry schema with optional embedded `verdictSnapshot`.
4. Analytics calculators derive aggregates on demand from journal records.
5. Feature flags to gate incomplete subfeatures; no broken navigation.

<a id="sec-6"></a>
## 6. Technical Requirements

<a id="sec-6-1"></a>
### 6.1 Architecture
- Module boundaries: `rules` ↔ `verdict` ↔ `journal`/`analytics`; keep pure functions where possible.
- Local-first storage adapter via `js/core/storage.js`; abstract keys behind helpers.

<a id="sec-6-2"></a>
### 6.2 Data Model
- Rule: `{ id, name, expression|params, active, priority, created_at, updated_at }`
- Verdict: `{ verdict, reasons: string[], ruleHits: string[], evaluated_at }`
- Trade (input): `{ symbol, side, size, entry, exit?, notes? }`
- Journal: `{ id, trade, verdictSnapshot?, pnl?, rr?, tags?, created_at }`

<a id="sec-6-3"></a>
### 6.3 Storage/Schema
- Keys (proposed): `etc_rules_v1`, `etc_journal_v1`, `etc_analytics_v1` (derived).
- Document versioning; include simple migration note for v2+.

<a id="sec-6-4"></a>
### 6.4 Validation
- Validate required fields; safe defaults; guard against invalid numbers/NaN.
- Deterministic evaluation order by `priority` then `created_at`.

<a id="sec-6-5"></a>
### 6.5 UI/UX
- Rules: labels, empty states, validation errors.
- Journal: form field hints; tags; success/failure toasts.
- Analytics: minimal card/table with counts and rates; avoid overclaiming.

<a id="sec-6-6"></a>
### 6.6 Legal/Privacy
- Educational-only copy on verdict/analytics views; avoid exposing personal data.

<a id="sec-6-7"></a>
### 6.7 Implementation Plan (Four-Level WBS, sequencing, rollback)

6.7.1 Rules CRUD
- 6.7.1.1 Storage layer
  - Define key `etc_rules_v1`; add helpers in `StorageCore` usage: `load/save/remove` for rules list.
  - Migration note: if `etc_rules_v2+` appears, shallow-copy compatible fields; otherwise reset.
- 6.7.1.2 Model and validation
  - Rule shape: `{ id:string, name:string, params|expression:any, active:boolean, priority:number, created_at:number, updated_at:number }`.
  - Add pure validators (name required; priority integer 0..999; safe defaults).
- 6.7.1.3 Module API
  - `Rules.create(ruleInput) → rule` (assign id/priority, persist);
  - `Rules.update(id, patch) → rule`;
  - `Rules.toggle(id, active)`;
  - `Rules.delete(id)`;
  - `Rules.listSorted() → Rule[]` (sort by `priority` asc, then `created_at`).
- 6.7.1.4 UI (minimal)
  - List with active/priority columns; inline toggle; simple form (name + priority).
  - Empty state; error toast from validator.
- 6.7.1.5 Feature flag
  - `flags.rules` in config; hide UI and block module entry when false.
- 6.7.1.6 Tests/QA mapping
  - Map to QA 7.1 cases (create/update/toggle/delete; ordering; persistence).

6.7.2 Verdict v0
- 6.7.2.1 Core evaluate function (pure)
  - `evaluate(tradeInput, rules) → { verdict:'allow'|'block'|'warn', reasons:string[], hits:string[], evaluated_at:number }`.
  - Deterministic order using `Rules.listSorted()`.
- 6.7.2.2 Rule evaluation contracts
  - Define minimal rule types or expression contract (e.g., predicate callbacks in params) with safe defaults.
- 6.7.2.3 Reason/hits capture
  - Collect triggered rule ids and human-readable reasons for UX.
- 6.7.2.4 Performance
  - Measure p95 on 100 evaluations in dev; target ≤ 3s end-to-end.
- 6.7.2.5 Feature flag
  - `flags.verdict` gates UI button/route.
- 6.7.2.6 Tests/QA mapping
  - Map to QA 7.1 case (deterministic evaluation + reasons match expectations).

6.7.3 Journal v0
- 6.7.3.1 Storage and schema
  - Key `etc_journal_v1`; entry: `{ id, trade, verdictSnapshot?, pnl?, rr?, tags?, created_at }`.
- 6.7.3.2 Module API
  - `Journal.create(entryInput)`, `Journal.update(id, patch)`, `Journal.delete(id)`, `Journal.list()`.
  - Optional verdict snapshot: embed the latest `evaluate()` result with `evaluated_at`.
- 6.7.3.3 UI (minimal)
  - New entry form (datetime default now, symbol, side, size, entry/exit, notes/tags, checkbox to include snapshot).
  - Edit/delete affordances; persistence across reload.
- 6.7.3.4 Feature flag
  - `flags.journal`.
- 6.7.3.5 Tests/QA mapping
  - Map to QA 7.1 case (create/edit entry with snapshot; persists).

6.7.4 Analytics v0 (derived)
- 6.7.4.1 Calculators (pure)
  - `calcCounts(entries)`, `calcWinRate(entries)`, `calcAverageRR(entries)`.
- 6.7.4.2 UI (minimal)
  - Cards/tables reflecting derived metrics; zero console errors.
- 6.7.4.3 Feature flag
  - `flags.analytics`.
- 6.7.4.4 Tests/QA mapping
  - Map to QA 7.1 case (counts, win rate, avg R:R reflect data accurately).

6.7.5 Navigation & Flags Integration
- 6.7.5.1 Router wires `#/wizard`, `#/saved`, `#/verdict`, `#/journal`, `#/analytics?`
- 6.7.5.2 Hide/disable routes and controls behind feature flags; ensure no broken navigation.
- 6.7.5.3 Console gate: zero errors/warnings in preview smoke per README.

6.7.6 Storage Keys and Versioning
- 6.7.6.1 Document keys: `etc_rules_v1`, `etc_journal_v1`, `etc_analytics_v1` (derived, optional cache).
- 6.7.6.2 Add migration note for v2+; safe fallback resets only the affected key.

6.7.7 Security/Privacy & Legal Copy
- 6.7.7.1 Ensure no PII beyond journal fields; keep email/auth out of scope (2.1.1.4).
- 6.7.7.2 Add "educational-only" copy to verdict/analytics views.
- 6.7.7.3 Run dependency/secrets/SAST scans; no High/Critical before Ready flip.

6.7.8 QA & Evidence
- 6.7.8.1 Update `QA/2.1.1.2-core-features-v0/test-cases.md` per 7.1.
- 6.7.8.2 Add Playwright smoke covering: Rules create→Verdict evaluate→Journal with snapshot→Analytics read.
- 6.7.8.3 Publish `QA/2.1.1.2-core-features-v0/test-results-<yyyy-mm-dd>.md` with Overall Status: Pass; attach screenshot(s).

6.7.9 Sequencing (dependency-aware)
- 1) Storage keys/contracts (6.7.6) →
- 2) Rules module + validators (6.7.1) →
- 3) Verdict evaluate (6.7.2) →
- 4) Journal + snapshot (6.7.3) →
- 5) Analytics calculators (6.7.4) →
- 6) UI wiring + flags (6.7.5) →
- 7) QA/E2E + evidence (6.7.8).

6.7.10 Rollback Notes
- If verdict performance exceeds p95 target, disable `flags.verdict` and ship Rules/Journal/Analytics-only while optimizing.
- If rules validation blocks editing, bypass validator with safe defaults and open a bug with reproduction; keep persistence stable.
- If storage migration fails, revert the affected key to last-known-good and retry with a guarded migration step.

<a id="sec-7"></a>
## 7. Testing & Acceptance

<a id="sec-7-1"></a>
### 7.1 Test Scenarios
1. Create rule; list shows rule active and ordered.
2. Evaluate verdict for a sample trade; rule hits and reasons align with rule definitions.
3. Create journal entry with optional verdict snapshot; data persists across reload.
4. Analytics reflects journal data (counts, win rate, avg R:R) accurately.
5. Feature flags disable incomplete subfeatures without breaking navigation.

<a id="sec-7-2"></a>
### 7.2 Acceptance Criteria
- All scenarios pass in dev preview; zero console errors; verdict p95 ≤ 3s.
- Overall Status: Pass in QA results; security evidence attached; no High/Critical.

<a id="sec-7-3"></a>
### 7.3 QA Artifacts
- Test cases file: `QA/2.1.1.2-core-features-v0/test-cases.md`
- Latest results: `QA/2.1.1.2-core-features-v0/test-results-2025-08-12.md` (Overall Status: Pass required)

<a id="sec-8"></a>
## 8. Changelog
- v1.0: Initial draft and QA scaffold created.

<a id="sec-9"></a>
## 9. Collaboration & Review Workflow

<a id="sec-9-1"></a>
### 9.1 Roles and Order
- PM → VP-Product → Technical Product Manager → CTO → Security → UX/UI → Legal → QA → VP‑Eng → Implementation Owner

<a id="sec-9-2"></a>
### 9.2 Where Communication Happens
- Primary: this PRD (`PRDs/M0/2.1.1.2-core-features-v0-prd.md`)
- Status: `Plans/product-roadmap.md` (2.1.1.2)

<a id="sec-9-3"></a>
### 9.3 Handoff Contracts (Inputs → Outputs)
- PM: Input strategy → Output scope, user stories, acceptance
- VP-Product: Input PM → Output KPIs/gates
- Technical Product Manager: Input PM/VP-Product → Output specs/API contracts & constraints; acceptance tests links
- CTO: Input PM/VP-Product → Output tech constraints/defaults; feature flags
- Security: Input PM/CTO → Output threat model/controls; scans plan
- UX: Input PM/CTO → Output labels/error states/empty states
- Legal: Input UX/CTO → Output approved disclaimer/privacy
- QA: Input PM/CTO/UX → Output test scenarios/acceptance checklist
- VP‑Eng: Input all → Output feasibility/sequencing (Ready)
- Implementation Owner: Input all → Output implementation plan + rollback note

<a id="sec-9-4"></a>
### 9.4 Review Log & Sign‑offs
- [ ] PM — Scope/user stories/acceptance confirmed
- [ ] VP-Product — Business alignment/KPIs confirmed
- [ ] Technical Product Manager — Specs/API contracts & constraints confirmed; §10 links to specs/tests
- [ ] CTO — Tech constraints/defaults confirmed; feature flags noted
- [ ] Security — Threat model/controls; scans attached; no High/Critical
- [ ] UX — UX notes/labels/error states confirmed
- [ ] Legal — Disclaimer/privacy approved (or N/A)
- [x] QA — Test scenarios/acceptance confirmed; results published at: `QA/2.1.1.2-core-features-v0/test-results-2025-08-12.md` (Overall Status: Pass)
- [ ] VP‑Eng — Feasibility/sequencing confirmed (Ready)
- [ ] Implementation Owner — Implementation risks and rollback plan confirmed

<a id="sec-9-5"></a>
### 9.5 Reviewer Notes
 - [QA 2025-08-12] Unit (3) and E2E (2) passed; published results at `QA/2.1.1.2-core-features-v0/test-results-2025-08-12.md`.
 - [Security 2025-08-12] `npm audit` shows 5 moderate issues; 0 High/Critical. Upgrades require major bumps (vite/vitest); deferred per M0 scope.

<a id="sec-9-6"></a>
### 9.6 Decision Log
 1. [2025-08-12] Proceed with local-first modules and minimal UI wiring; no DB/auth dependencies.
 2. [2025-08-12] Accept moderate-only dependency advisories in dev tooling; no High/Critical; defer major upgrades to M1.

<a id="sec-9-7"></a>
### 9.7 Open Questions
- Rules ordering: explicit priority integer vs stable sort by creation with secondary tiebreaker?
- Journal analytics window: all-time vs last N days configurable?
- Storage versioning: v1 → v2 migration rules and detection?

<a id="sec-9-8"></a>
### 9.8 Ready‑to‑Implement Gate
- Condition: All boxes checked in 9.4 AND QA results published with Overall Status: Pass and linked above.
- Action: Flip status in roadmap and start implementation; mirror HTML.

<a id="sec-10"></a>
## 10. Excellence Checklist (link evidence per `docs/Excellence-Standard.md`)
- [x] Scope/intent clear; dependencies and order documented
- [x] Minimal, reversible edits; rollback steps noted in 9.6 (if risk > low)
- [x] Lints/build/unit/E2E green
- [x] QA results published and linked: `QA/2.1.1.2-core-features-v0/test-results-2025-08-12.md` (Overall Status: Pass)
- [x] Security evidence linked (dependency audit): 0 High/Critical outstanding
- [x] Performance/size budgets respected (N/A for local-only; build size OK)
- [x] Roadmap + `docs/product-roadmap.html` updated; links clickable
- [x] Token‑efficient summary and diffs; no redundant docs or dead code


