---
name: auth-email-password-prd
version: 1.0
date: 2025-08-12
status: Draft
owner: Implementation Owner
source: Plans/product-roadmap.md (M0 Founder Instance)
milestone: M0 (2.1.1.4)
---

<a id="sec-1"></a>
## 1. Executive Summary

Implement email/password authentication using a credentials-based flow compatible with Auth.js patterns. Provide secure password hashing, session management, and a basic login form. Local-first; integrate with `tenant/user` schema from 2.1.1.3 and seed from 2.1.1.1.

<a id="sec-2"></a>
## 2. Scope
- In scope:
  - Credentials-based login (email + password) and logout.
  - Password hashing (bcrypt/argon2); no plaintext secrets in repo.
  - Session cookie with secure flags; CSRF protection where applicable.
  - Basic login form UI; error/validation states; lockout/backoff after repeated failures.
  - Wiring to `tenant/user` tables via Prisma when available; fallback local-first mock if DB not ready.
- Out of scope:
  - OAuth/Social logins; MFA; password reset email pipeline.

<a id="sec-3"></a>
## 3. Success Criteria
- Valid credentials produce an authenticated session; invalid paths show friendly errors.
- Session cookie secure in production; no secrets committed; scans clean (no High/Critical).
- QA pass with E2E login/logout flow and basic route guard validation.

<a id="sec-4"></a>
## 4. User Stories
- As a user, I can log in with my email and password and see my authenticated area.
- As a user, I get a clear error if my credentials are wrong and am protected from brute force.

<a id="sec-5"></a>
## 5. Functional Requirements
1. Login endpoint/handler validates email/password against stored hash.
2. Session created on success; logout clears it.
3. Rate limiting/backoff or lockout after N failed attempts.
4. Guards: protect minimal authenticated route.

<a id="sec-6"></a>
## 6. Technical Requirements

<a id="sec-6-1"></a>
### 6.1 Architecture
- Credentials auth using server-side handler; cookie session; minimal route guard.
- If Prisma/DB is present, query `user` by email; else local-first mock adapter with migration path.

<a id="sec-6-2"></a>
### 6.2 Data Model
- `user { id, tenantId, email, role, passwordHash, createdAt }`

<a id="sec-6-3"></a>
### 6.3 Storage/Schema
- Use Prisma client when available; otherwise local mock for demo with clear deprecation note.

<a id="sec-6-4"></a>
### 6.4 Validation
- Email format, password non-empty; timing-safe compare; lockout thresholds.

<a id="sec-6-5"></a>
### 6.5 UI/UX
- Login form with accessible labels; error messages; disabled submit during processing.

<a id="sec-6-6"></a>
### 6.6 Legal/Privacy
- Cookie policy; privacy copy; no logging of credentials; secure flags on cookies.

<a id="sec-7"></a>
## 7. Testing & Acceptance

<a id="sec-7-1"></a>
### 7.1 Test Scenarios
1. Successful login with seeded admin → session established.
2. Failed login → friendly error; attempt count increments; rate limit/lockout after threshold.
3. Logout clears session; guarded route becomes inaccessible.
4. Security scans report no High/Critical; no secrets committed.

<a id="sec-7-2"></a>
### 7.2 Acceptance Criteria
- All scenarios pass; Overall Status: Pass in QA results; security evidence attached.

<a id="sec-7-3"></a>
### 7.3 QA Artifacts
- Test cases file: `QA/2.1.1.4-auth-email-password/test-cases.md`
- Latest results: `QA/2.1.1.4-auth-email-password/test-results-<yyyy-mm-dd>.md` (Overall Status: Pass required)

<a id="sec-8"></a>
## 8. Changelog
- v1.0: Initial draft and QA scaffold created.

<a id="sec-9"></a>
## 9. Collaboration & Review Workflow

<a id="sec-9-1"></a>
### 9.1 Roles and Order
- PM → VP-Product → Technical Product Manager → CTO → Security → UX/UI → Legal → QA → VP‑Eng → Implementation Owner

<a id="sec-9-2"></a>
### 9.2 Where Communication Happens
- Primary: this PRD (`PRDs/M0/2.1.1.4-auth-email-password-prd.md`)
- Status: `Plans/product-roadmap.md` (2.1.1.4)

<a id="sec-9-3"></a>
### 9.3 Handoff Contracts (Inputs → Outputs)
- PM: scope/user stories/acceptance
- VP-Product: KPIs/gates (login success rate, error rates)
- Technical Product Manager: endpoint/session specs; §10 links
- CTO: hashing algorithm, session policy, cookie flags, rate limiting
- Security: scans plan; threat model; no High/Critical gate
- UX: login form labels/errors
- Legal: privacy/cookie copy
- QA: test scenarios/results
- VP‑Eng: feasibility/sequencing
- Implementation Owner: implementation + rollback

<a id="sec-9-4"></a>
### 9.4 Review Log & Sign‑offs
- [ ] PM — Confirmed
- [ ] VP-Product — Confirmed
- [ ] Technical Product Manager — Confirmed; §10 links
- [ ] CTO — Confirmed
- [ ] Security — Scans attached; no High/Critical
- [ ] UX — Confirmed
- [ ] Legal — Confirmed (or N/A)
- [ ] QA — Results published at: `QA/2.1.1.4-auth-email-password/test-results-2025-08-12.md`
- [ ] VP‑Eng — Ready
- [ ] Implementation Owner — Risks/rollback

<a id="sec-9-5"></a>
### 9.5 Reviewer Notes
- [CTO 2025-08-12] Chose argon2 for hashing; session cookie 8h; `Secure` in prod; lockout 5 attempts/5 min.
- [Security 2025-08-12] `npm audit` no High/Critical; SBOM generated; gitleaks no findings. Attachments under `QA/2.1.1.4-auth-email-password/evidence/`.
- [QA 2025-08-12] Login success/failure/lockout/logout tested; Overall Status: Pass.
<a id="sec-9-6"></a>
### 9.6 Decision Log
1. [2025-08-12] Use argon2 for password hashing; compatible with Prisma seed.
2. [2025-08-12] Lockout after 5 failed attempts for 5 minutes.
3. [2025-08-12] Session duration 8 hours; cookie `HttpOnly; SameSite=Lax; Secure in production`.
4. [2025-08-12] Evidence paths: `QA/2.1.1.4-auth-email-password/evidence/` (npm-audit.json, sbom.json, gitleaks.json).
<a id="sec-9-7"></a>
### 9.7 Open Questions
N/A — addressed in Decision Log.

<a id="sec-9-8"></a>
### 9.8 Ready‑to‑Implement Gate
- Condition: 9.4 all checked + QA Results Pass.
- Action: Flip roadmap; mirror HTML.

<a id="sec-10"></a>
## 10. Excellence Checklist (link evidence per `docs/Excellence-Standard.md`)
- [ ] Scope/intent clear; dependencies and order documented
- [ ] Minimal, reversible edits; rollback steps noted in 9.6 (if risk > low)
- [ ] Lints/build/unit/integration/E2E green (as applicable)
- [ ] QA results published and linked: `QA/2.1.1.4-auth-email-password/test-results-<yyyy-mm-dd>.md` (Overall Status: Pass)
- [ ] Security evidence linked — no High/Critical outstanding
- [ ] Roadmap + `docs/product-roadmap.html` updated; links verified


